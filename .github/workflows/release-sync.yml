name: Sync Upstream Releases

on:
  schedule:
    - cron: '0 3 * * *'   # æ¯å¤©å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-release:
    name: Sync releases from upstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch upstream releases list
        run: |
          echo "ğŸ“¥ è·å– upstream releases"
          gh release list --repo ihmily/StreamCap --limit 100 > upstream.txt
          gh release list --limit 100 > my.txt
          echo "âœ… åˆ—å‡º upstream release å®Œæˆ"

      - name: Find new tags
        id: find_tags
        run: |
          comm -23 <(cut -f1 -d$'\t' upstream.txt | sort) <(cut -f1 -d$'\t' my.txt | sort) | grep -vE '^\s*$|^-$' > new_tags.txt
          echo "ğŸ§© ä»¥ä¸‹æ˜¯æœªåŒæ­¥çš„ tagï¼š"
          cat new_tags.txt || echo "(æ— æ–° tag)"
          echo "new_tags=$(cat new_tags.txt | paste -sd ',' -)" >> "$GITHUB_OUTPUT"

      - name: Sync releases
        if: steps.find_tags.outputs.new_tags != ''
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥æ–° releases"
          for tag in $(cat new_tags.txt); do
            echo "ğŸ”„ åŒæ­¥ release: $tag"

            release_json=$(gh release view "$tag" --repo ihmily/StreamCap --json tagName,name,body,isDraft,isPrerelease)
            name=$(echo "$release_json" | jq -r '.name')
            body=$(echo "$release_json" | jq -r '.body')
            draft=$(echo "$release_json" | jq -r '.isDraft')
            prerelease=$(echo "$release_json" | jq -r '.isPrerelease')

            mkdir -p downloads
            gh release download "$tag" --repo ihmily/StreamCap --dir ./downloads || echo "âš ï¸ æ— é™„ä»¶"

            if [ -n "$(ls -A ./downloads)" ]; then
              gh release create "$tag" ./downloads/* \
                --title "$name" \
                --notes "$body" \
                $( [ "$draft" == "true" ] && echo "--draft" ) \
                $( [ "$prerelease" == "true" ] && echo "--prerelease" )
            else
              gh release create "$tag" \
                --title "$name" \
                --notes "$body" \
                $( [ "$draft" == "true" ] && echo "--draft" ) \
                $( [ "$prerelease" == "true" ] && echo "--prerelease" )
            fi

            echo "âœ… Release [$tag] åŒæ­¥å®Œæˆ"
            rm -rf ./downloads
          done

      - name: å®Œæˆæç¤º
        run: echo "ğŸ‰ Release åŒæ­¥æµç¨‹æ‰§è¡Œå®Œæ¯•"
